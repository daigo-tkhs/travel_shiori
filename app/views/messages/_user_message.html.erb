<%# app/views/messages/_user_message.html.erb %>
<%# ローカル変数: message %>

<%= turbo_frame_tag dom_id(message) do %>
  <div class="flex justify-end items-start gap-3 mb-6 group">
    
    <div class="flex flex-col items-end max-w-[80%]">
      <%# 吹き出しデザイン %>
      <div class="bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-sm text-sm md:text-base leading-relaxed">
        <%= simple_format(message.prompt, class: "mb-0") %>
      </div>
      
      <div class="flex items-center justify-end gap-3 mt-1.5 px-1">
        <div class="flex items-center gap-2 text-[10px] text-gray-400">
          <%# nickname を使用 %>
          <span class="font-bold text-gray-500"><%= message.user&.nickname || "Unknown" %></span>
          <span><%= message.created_at.strftime("%H:%M") %></span>
        </div>

        <% if message.user_id == current_user.id %>
          <div class="flex items-center gap-2 text-[10px] opacity-0 group-hover:opacity-100 transition-all">
            <%= link_to "編集", edit_trip_message_path(message.trip, message), 
              class: "text-blue-500 hover:underline",
              data: { turbo_frame: dom_id(message) } %>
            <span class="text-gray-200">|</span>
            <%= button_to '削除', trip_message_path(message.trip, message), 
              method: :delete, 
              data: { turbo_confirm: 'このメッセージを削除しますか？' },
              class: 'text-red-400 hover:text-red-600' %>
          </div>
        <% end %>
      </div>
    </div>

    <%# アイコンエリア（修正済） %>
    <div class="flex-shrink-0">
      <%# avatarメソッドが存在し、かつ添付ファイルがある場合のみ画像を表示 %>
      <% if message.user&.respond_to?(:avatar) && message.user.avatar&.attached? %>
        <%= image_tag message.user.avatar, class: "w-9 h-9 rounded-full object-cover border-2 border-white shadow-sm" %>
      <% else %>
        <%# それ以外（画像なし、またはavatar未定義）の場合はイニシャルを表示 %>
        <div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 text-xs font-bold border border-blue-100 shadow-sm">
          <%= message.user&.nickname&.first&.upcase || "U" %>
        </div>
      <% end %>
    </div>

  </div>
<% end %>