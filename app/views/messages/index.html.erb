<%# app/views/messages/index.html.erb %>
<% @hide_header = true %>
<% @hide_footer = true %>

<div class="flex flex-col w-full h-[100dvh] bg-gray-50 overflow-hidden">

  <%# --- 1. チャット専用ヘッダー --- %>
  <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-md flex-shrink-0 w-full">
    <div class="max-w-7xl mx-auto px-4 py-3 md:py-4">
      <div class="flex items-center justify-between gap-3">
        
        <%# 戻るボタン %>
        <%= link_to trip_path(@trip), class: "group flex items-center gap-1 pl-2 pr-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-full transition-all flex-shrink-0 text-white" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:-translate-x-0.5 transition-transform">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
          <span class="text-xs md:text-sm font-bold">旅程に戻る</span>
        <% end %>

        <%# タイトル %>
        <div class="flex-1 min-w-0">
          <h1 class="text-lg md:text-xl font-bold leading-tight truncate"><%= @trip.title %></h1>
          <div class="flex items-center gap-2 text-blue-100 text-xs font-medium">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-300 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-400"></span>
            </span>
            AIトラベルアシスタントがサポート中
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# --- 2. メッセージ表示エリア (ここだけスクロール) --- %>
  <div class="flex-1 overflow-y-auto w-full relative scroll-smooth">
    <div class="max-w-7xl mx-auto px-4 py-8 space-y-6 pb-40">
      
      <%# 初回メッセージ %>
      <div class="flex justify-start items-start gap-3">
        <div class="w-10 h-10 rounded-full bg-purple-100 flex-shrink-0 border border-purple-200 overflow-hidden shadow-sm">
          <%= image_tag "ai_concierge_icon.png", class: "w-full h-full object-cover", alt: "AI Icon" %>
        </div>
        <div class="bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 text-sm md:text-base text-gray-800 shadow-sm max-w-[85%] leading-relaxed">
          <p class="font-bold text-purple-600 text-xs mb-1">AI Concierge</p>
          こんにちは！「<%= @trip.title %>」の計画をお手伝いします。<br>
          おすすめの観光スポットや、移動時間の相談、予算に合わせたプラン提案など、何でも気軽に話しかけてくださいね。
        </div>
      </div>

      <%# 会話履歴 %>
      <%= turbo_frame_tag "messages", class: "space-y-6" do %>
        <% last_date = nil %>
        <% @messages.each do |message| %>
          <%# 日本時間で日付を取得 %>
          <% current_date = message.created_at.in_time_zone('Tokyo').to_date %>
          
          <%# 日付が変わったら区切り線を表示 %>
          <% if last_date != current_date %>
            <div class="flex justify-center my-6">
              <span class="bg-gray-200 text-gray-600 text-[10px] px-3 py-1 rounded-full font-bold shadow-sm">
                <%= current_date.strftime("%Y/%m/%d (%a)") %>
              </span>
            </div>
            <% last_date = current_date %>
          <% end %>

          <% if message.user_id.present? %>
            <%= render "messages/user_message", message: message %>
          <% else %>
            <%= render "messages/ai_message", message: message %>
          <% end %>
        <% end %>
      <% end %>

      <div class="mt-12 mb-6 text-center px-4">
        <%= link_to trip_path(@trip), class: "inline-flex items-center justify-center gap-3 w-auto mx-auto px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold text-lg rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" />
          </svg>
          旅程サマリーを確認する
        <% end %>
      </div>
      
      <div id="scroll-anchor" class="h-1"></div>
    </div>
  </div>

  <%# --- 3. 固定入力フォーム (画面最下部) --- %>
  <div class="bg-white border-t border-gray-200 p-3 shadow-[0_-10px_20px_rgba(0,0,0,0.02)] z-40 w-full">
    <div class="max-w-7xl mx-auto">
      <div id="new_message_area">
        <%= render "messages/form", trip: @trip, message: @message %>
      </div>
      <p class="text-[10px] text-gray-400 text-center mt-2">
        AIは間違った情報を生成することがあります。重要な情報はご自身で確認してください。
      </p>
    </div>
  </div>

</div>