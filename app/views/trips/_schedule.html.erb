<%# app/views/trips/_schedule.html.erb %>
<%# ローカル変数: trip, spots_by_day %>

<div class="schedule-section space-y-6">
  <% if spots_by_day.present? %>
    <% spots_by_day.each do |day_num, spots| %>
      <div class="day-block">
        <div class="sticky top-[68px] z-20 -mx-4 px-4 py-2 bg-gray-100/95 backdrop-blur-sm border-y border-gray-200 flex justify-between items-center mb-4 lg:mx-0 lg:rounded-lg">
          <div class="flex items-center gap-2">
            <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">DAY <%= day_num %></span>
            <span class="text-sm font-bold text-gray-700">
              <% if trip.start_date %>
                <% target_date = trip.start_date + (day_num - 1).days %>
                <%= target_date.strftime("%m月%d日") %> (<%= %w(日 月 火 水 木 金 土)[target_date.wday] %>)
              <% else %>
                日付未定
              <% end %>
            </span>
          </div>
        </div>

        <%# この div がドラッグ＆ドロップの「入れ物」になります %>
        <div class="relative border-l-2 border-gray-200 ml-4 pl-6 space-y-6 pb-4 min-h-[100px]"
            data-controller="sortable"
            data-sortable-url-value="<%= move_trip_spot_path(trip, ':id') %>"
            data-day-number="<%= day_num %>">
          
          <% spots.each do |spot| %>
            <div class="relative group cursor-move" data-id="<%= spot.id %>">
              <div class="absolute -left-[31px] top-0 w-4 h-4 rounded-full bg-white border-2 border-blue-500"></div>
              
              <div class="bg-white rounded-xl p-3 border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex gap-3">
                  <%# 画像プレースホルダー %>
                  <div class="flex-shrink-0">
                    <div class="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden relative">
                      <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                        </svg>
                      </div>
                    </div>
                  </div>

                  <div class="flex-1 min-w-0 flex flex-col justify-between py-0.5">
                    <div>
                      <h3 class="text-gray-900 font-bold text-sm leading-tight mb-1 truncate"><%= spot.name %></h3>
                      <p class="text-xs text-gray-500 flex items-center gap-1">
                        <span class="inline-block w-1.5 h-1.5 rounded-full bg-green-400"></span>
                        観光スポット
                      </p>
                    </div>

                    <div class="flex items-center gap-3 text-xs font-medium text-gray-600 mt-2">
                      <div class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5 text-gray-400">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" />
                        </svg>
                        <span><%= spot.duration %>分</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5 text-gray-400">
                          <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                        </svg>
                        <span>¥<%= number_with_delimiter(spot.estimated_cost) %></span>
                      </div>
                    </div>

                    <%# 操作ボタン %>
                    <% if trip.editable_by?(current_user) %>
                      <div class="mt-2 flex justify-end gap-2">
                        <%= link_to edit_trip_spot_path(trip, spot), class: "text-xs text-gray-400 hover:text-blue-600 p-1" do %>
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3L10.58 12.42a4 4 0 0 1-1.343.886l-3.155 1.262a.5.5 0 0 1-.65-.65Z" />
                            <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" />
                          </svg>
                        <% end %>
                        <%= button_to trip_spot_path(trip, spot), method: :delete, class: "text-xs text-gray-300 hover:text-red-500 p-1", form: { data: { turbo_confirm: "削除しますか？" } } do %>
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
                          </svg>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>

              <%# 移動時間表示 %>
              <% if spot.travel_time.to_i > 0 %>
                <div class="flex items-center justify-center gap-2 text-xs text-gray-400 my-4 -ml-4">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path d="M6.5 3c-1.051 0-2.093.04-3.125.117A1.49 1.49 0 0 0 2 4.607V10.5h9V4.606c0-.771-.59-1.43-1.375-1.489A41.568 41.568 0 0 0 6.5 3ZM2 12v2.5A1.5 1.5 0 0 0 3.5 16h.041a3 3 0 0 1 5.918 0h.791a.75.75 0 0 0 .75-.75V12H2Z" />
                    <path d="M13.25 5a.75.75 0 0 0-.75.75v8.514a3.001 3.001 0 0 1 4.893 1.44c.37-.275.61-.719.595-1.231a20.381 20.381 0 0 0-.176-2.635L17.5 7.5c0-1.33-.96-2.5-2.406-2.5h-.844ZM15.5 18a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                  </svg>
                  <span class="font-bold">移動 <%= spot.travel_time %>分 (車)</span>
                </div>
              <% end %>
            </div> 
          <% end %>
        </div>
      </div>
    <% end %>
    
    <% if trip.editable_by?(current_user) %>
      <div class="mt-6 text-center">
        <%= link_to new_trip_spot_path(trip), class: "inline-flex items-center gap-2 bg-white border-2 border-blue-500 text-blue-600 px-6 py-2 rounded-full font-bold text-sm hover:bg-blue-50 transition-colors shadow-sm" do %>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
            <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
          </svg>
          スポットを追加
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-10 border-2 border-dashed border-gray-200 rounded-lg bg-gray-50">
      <p class="text-gray-500 text-sm mb-4">まだスポットが登録されていません</p>
      <% if trip.editable_by?(current_user) %>
        <%= link_to 'スポットを登録する', new_trip_spot_path(trip), class: "text-blue-600 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-full text-xs font-bold transition-colors" %>
      <% end %>
    </div>
  <% end %>
</div>