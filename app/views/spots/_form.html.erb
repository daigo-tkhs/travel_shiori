<%# app/views/spots/_form.html.erb %>

<%# APIキーの取得：ENVを優先的に使用するシンプルな記述に変更 %>
<% api_key_value = ENV['GOOGLE_MAPS_API_KEY'] || Rails.application.credentials.dig(:google_maps, :api_key) %>

<%= form_with model: [trip, spot],
  data: { 
    controller: "geocoding", 
    'geocoding-api-key-value': api_key_value 
  }, 
  class: "space-y-8" do |f| %>
  
  <%= render 'shared/error_messages', resource: spot %>

  <%# --- 1. 日程選択 --- %>
  <div class="space-y-2">
    <%= f.label :day_number, "何日目の予定？", class: "block text-sm font-bold text-gray-700 ml-1" %>
    
    <div class="relative">
      <%= f.select :day_number, 
          trip_days_options(trip), 
          { include_blank: false }, 
          class: "w-full pl-4 pr-10 py-3.5 rounded-xl border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-bold text-lg appearance-none cursor-pointer" %>
      
      <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
        </svg>
      </div>
    </div>
  </div>

  <%# --- 2. スポット名 --- %>
  <div class="space-y-2">
    <%= f.label :name, "スポット名 (必須)", class: "block text-sm font-bold text-gray-700 ml-1" %>
    <%= f.text_field :name, 
        required: true, 
        placeholder: "例: 旭山動物園", 
        class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all placeholder-gray-400",
        data: { 'geocoding-target': 'address', action: 'keydown->geocoding#geocodeDebounced' } 
    %>
    <%= f.hidden_field :latitude, data: { 'geocoding-target': 'latitude' } %>
    <%= f.hidden_field :longitude, data: { 'geocoding-target': 'longitude' } %>
  </div>

  <%# --- 3. 概算費用 & 滞在時間 --- %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    
    <%# 概算費用 %>
    <div class="space-y-2">
      <%= f.label :estimated_cost, "概算費用 (円)", class: "block text-sm font-bold text-gray-700 ml-1" %>
      <div class="flex items-center gap-3">
        <span class="text-xl font-bold text-gray-400">¥</span>
        <div class="flex-1">
          <%= f.number_field :estimated_cost, min: 0, placeholder: "1000", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" %>
        </div>
      </div>
    </div>

    <%# 滞在時間（時間・分） %>
    <div class="space-y-2">
      <%= f.label :duration_hours, "滞在時間", class: "block text-sm font-bold text-gray-700 ml-1" %>
      <div class="flex items-center gap-4">
        <%# 時間入力 %>
        <div class="flex-1 relative">
          <div class="flex items-center gap-2">
            <%= f.number_field :duration_hours, min: 0, placeholder: "1", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all text-center" %>
            <span class="text-sm font-bold text-gray-500 whitespace-nowrap">時間</span>
          </div>
        </div>
        <%# 分入力 %>
        <div class="flex-1 relative">
          <div class="flex items-center gap-2">
            <%= f.number_field :duration_minutes, min: 0, max: 59, placeholder: "30", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all text-center" %>
            <span class="text-sm font-bold text-gray-500 whitespace-nowrap">分</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# --- 4. アクションボタン --- %>
  <div class="pt-6">
    <%= f.submit btn_text, class: "w-full py-4 px-6 rounded-full text-white font-bold bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 shadow-lg transform active:scale-95 transition-all cursor-pointer text-lg" %>
    
    <div class="mt-4 text-center">
      <%= link_to "キャンセルして戻る", trip_path(trip), class: "text-sm font-bold text-gray-400 hover:text-gray-600 transition underline decoration-gray-300" %>
    </div>
  </div>
<% end %>