<%# app/views/spots/_form.html.erb %>

<% api_key_value = Rails.application.credentials.dig(:google_maps, :api_key) || ENV['GOOGLE_MAPS_API_KEY'] || ENV['Maps_API_KEY'] %>

<%# ★ data: { turbo: false } で Turbo を完全に無効化し、通常のリダイレクトを強制します %>
<%= form_with model: [trip, spot],
  data: { 
    turbo: false,
    controller: "geocoding", 
    'geocoding-api-key-value': api_key_value 
  }, 
  class: "space-y-5" do |f| %>
  
  <% if spot.errors.any? %>
    <div class="bg-red-50 text-red-600 p-4 rounded-lg text-sm mb-4 border border-red-200">
      <ul class="list-disc pl-5 space-y-1">
        <% spot.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= f.label :day_number, "何日目？", class: "block text-sm font-bold text-gray-700 mb-1" %>
    <%= f.number_field :day_number, min: 1, required: true, class: "w-20 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-center" %>
  </div>

  <div>
    <%= f.label :name, "スポット名 (必須)", class: "block text-sm font-bold text-gray-700 mb-1" %>
    <%= f.text_field :name, required: true, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
        data: { 'geocoding-target': 'address', action: 'keydown->geocoding#geocodeDebounced' } %>
    <%= f.hidden_field :latitude, data: { 'geocoding-target': 'latitude' } %>
    <%= f.hidden_field :longitude, data: { 'geocoding-target': 'longitude' } %>
  </div>

  <div class="grid grid-cols-2 gap-4">
    <div>
      <%= f.label :estimated_cost, "概算費用 (円)", class: "block text-sm font-bold text-gray-700 mb-1" %>
      <%= f.number_field :estimated_cost, min: 0, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
    </div>
    <div>
      <%= f.label :duration, "滞在時間 (分)", class: "block text-sm font-bold text-gray-700 mb-1" %>
      <%= f.number_field :duration, min: 0, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
    </div>
  </div>

  <div class="flex items-center gap-2 py-2">
    <%= f.check_box :reservation_required, class: "w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" %>
    <%= f.label :reservation_required, "このスポットは予約が必要", class: "text-sm font-bold text-gray-700" %>
  </div>
  
  <div>
    <%= f.label :booking_url, "予約/参考URL", class: "block text-sm font-bold text-gray-700 mb-1" %>
    <%= f.url_field :booking_url, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" %>
  </div>

  <div class="pt-4">
    <%= f.submit btn_text, class: "w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-sm cursor-pointer" %>
    
    <%= link_to "キャンセル", trip_path(trip), data: { turbo: false }, class: "block w-full text-center text-gray-500 py-3 mt-2 hover:text-gray-700 transition text-sm underline" %>
  </div>
<% end %>